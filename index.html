<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prix au m² — Maisons & Appartements (France)</title>
  <link rel="preconnect" href="https://api-adresse.data.gouv.fr">
  <style>
    :root { --radius: 16px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; line-height: 1.4; margin: 0; background: #0b1020; color: #eef2ff; }
    header { padding: 24px 16px; text-align: center; background: linear-gradient(180deg,#141a33,#0b1020); border-bottom: 1px solid #1b2250; }
    h1 { margin: 0 0 8px; font-size: clamp(20px, 3vw, 28px); }
    p.sub { margin: 0; opacity: .8; }
    main { max-width: 800px; margin: 24px auto; padding: 0 16px 64px; }
    .card { background: #0f1631; border: 1px solid #1b2250; border-radius: var(--radius); padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    input[type="text"], select { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #283060; background: #0b1128; color: #e6e9ff; outline: none; }
    button { padding: 12px 16px; border-radius: 12px; border: 1px solid #283060; background: #3240ff; color: white; cursor: pointer; font-weight: 600; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    small.hint { display: block; margin-top: 8px; color: #aabbff; opacity: .8; }
    .result { margin-top: 16px; display: none; }
    .result.show { display: block; }
    .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px; }
    .stat { background: #0b1128; border: 1px solid #283060; border-radius: 12px; padding: 12px; }
    .stat h3 { margin: 0 0 4px; font-size: 14px; opacity: .9; }
    .stat .val { font-size: 22px; font-weight: 800; }
    .muted { opacity: .7; font-size: 12px; }
    footer { margin-top: 24px; text-align: center; opacity: .7; font-size: 12px; }
    .error { background: #2b1130; border: 1px solid #602850; color: #ffd1df; border-radius: 12px; padding: 10px 12px; }
    .loader { display:inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,.25); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; vertical-align: middle; margin-left: 6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    table { width:100%; border-collapse:collapse }
    th, td { padding:8px; border-bottom:1px solid #1b2250 }
    th { border-bottom:1px solid #283060 }
  </style>
</head>
<body>
  <header>
    <h1>Prix au m² — France</h1>
    <p class="sub">Maisons & Appartements — 12 et 24 derniers mois glissants</p>
  </header>

  <main>

<div class="card" style="margin-top:16px">
  <h3 style="margin:0 0 8px">Bassin de vie</h3>
  <div id="basin-msg" class="muted" style="margin-top:4px"></div>
  <div id="basin-out" style="margin-top:8px"></div>
</div>
    
    <div class="card">
      <label for="ville">Ville</label>
      <div class="row" style="margin-top:8px">
        <input id="ville" type="text" placeholder="Tapez une ville (ex. Bordeaux)" autocomplete="off" />
        <button id="btn" disabled>Rechercher</button>
      </div>
      <small class="hint">Astuce : choisissez la <b>commune</b> exacte dans la liste proposée (API Adresse).</small>
      <div id="suggestions" class="muted" style="margin-top:8px"></div>
      <div id="msg" style="margin-top:12px"></div>
      <div id="out" class="result"></div>

      <button id="btn-seloger" style="margin-top:12px">Chercher les prix constatés (SeLoger)</button>
      <div id="seloger-out" class="result"></div>
    </div>

    <!-- Bloc CLASSEMENT -->
    <div class="card" style="margin-top:16px">
  <h3 style="margin:0 0 8px">Classement par département</h3>

<div class="row" style="grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1fr auto; gap:8px">
  <input id="dept-code" type="text" placeholder="Code dép. (ex. 74, 13, 2A, 2B)" />
  <select id="period">
    <option value="12">12 mois</option>
    <option value="24">24 mois</option>
  </select>
  <select id="kind">
    <option value="appart">Appartements</option>
    <option value="maison">Maisons</option>
  </select>
  <select id="order">
    <option value="desc">Décroissant</option>
    <option value="asc">Croissant</option>
  </select>
  <input id="pop-min" type="number" placeholder="Hab. mini" value="1500" />
  <input id="pop-max" type="number" placeholder="Hab. maxi" value="3500" />
  <button id="btn-ranking">Voir</button>
</div>


  <div id="ranking-msg" class="muted" style="margin-top:8px"></div>
  <div id="ranking-out" style="margin-top:8px"></div>
</div>

    <div id="epci-out" class="result" style="margin-top:8px"></div>

    <footer>
      <p>Sources : <a href="https://api-adresse.data.gouv.fr" target="_blank" rel="noreferrer">API Adresse</a> &nbsp;•&nbsp; DVF (Etalab/DGFIP)</p>
    </footer>
  </main>

 <script>
  // ---------- Helpers ----------
  function euro(n){ if (n == null || Number.isNaN(n)) return "N/A";
    return new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR', maximumFractionDigits: 0 }).format(n); }
  function number(n){ return new Intl.NumberFormat('fr-FR').format(n ?? 0); }
  async function loadJSON(url){
    const r = await fetch(url + '?nocache=' + Date.now(), { cache: 'no-store' });
    if(!r.ok) throw new Error('HTTP ' + r.status);
    return await r.json();
  }
  async function fetchPopulationOne(insee) {
    const r = await fetch(`https://geo.api.gouv.fr/communes/${encodeURIComponent(insee)}?fields=nom,population&format=json`);
    if (!r.ok) return null; const j = await r.json(); return j.population ?? null;
  }


// ---- EPCI helpers -------------------------------------------------

async function fetchEPCIForCommune(insee) {
  // Renvoie { code: '2000xxxxx', nom: 'Communauté XXX' } ou null
  try {
    const r = await fetch(
      `https://geo.api.gouv.fr/communes/${encodeURIComponent(insee)}/intercommunalite?format=json`
    );
    if (!r.ok) return null;
    return await r.json();
  } catch (_) {
    return null;
  }
}

async function fetchCommunesOfEPCI(epciCode) {
  // Renvoie [{code, nom, population?}, ...] ou []
  try {
    const r = await fetch(
      `https://geo.api.gouv.fr/epcis/${encodeURIComponent(epciCode)}/communes?format=json&fields=code,nom,population`
    );
    if (!r.ok) return [];
    return await r.json();
  } catch (_) {
    return [];
  }
}

// Optionnel: index rapide des populations locales (si tu as communes_min.json ou population.json chargés)
function getLocalPopulationByInseeGetter() {
  // Essaie d'abord population.json (POP_DATA), sinon communes_min.json (COMMUNES_MIN), sinon null.
  const byInsee = {};

  if (window.POP_DATA && typeof window.POP_DATA === 'object') {
    for (const [code, pop] of Object.entries(window.POP_DATA)) {
      if (Number.isFinite(pop)) byInsee[code] = pop;
    }
  }
  if (Array.isArray(window.COMMUNES_MIN)) {
    for (const c of window.COMMUNES_MIN) {
      if (c && c.code && Number.isFinite(c.population) && byInsee[c.code] == null) {
        byInsee[c.code] = c.population;
      }
    }
  }
  return (insee) => byInsee[insee] ?? null;
}

async function computeEPCIInfo(insee) {
  const epci = await fetchEPCIForCommune(insee);
  if (!epci || !epci.code) return null;

  const communes = await fetchCommunesOfEPCI(epci.code);
  const getLocalPop = getLocalPopulationByInseeGetter();

  let totalPop = 0;
  let missing = 0;

  for (const c of communes) {
    // priorité: ta donnée locale ; sinon champ population de l’API ; sinon inconnu
    let p = getLocalPop(c.code);
    if (p == null && Number.isFinite(c.population)) p = c.population;

    if (Number.isFinite(p)) totalPop += p;
    else missing++;
  }

  return {
    code: epci.code,
    nom: epci.nom,
    nb: communes.length,
    population: totalPop,
    missing
  };
}

function renderEPCI(epciInfo) {
  if (!epciInfo) {
    return `<div class="error">EPCI introuvable pour cette commune.</div>`;
  }
  const missTxt = epciInfo.missing
    ? ` <span class="muted">(± ${number(epciInfo.missing)} communes sans population)</span>`
    : '';
  return `
    <div class="muted"><b>EPCI :</b> ${epciInfo.nom} (${epciInfo.code}) —
      ${number(epciInfo.nb)} communes — population ${number(epciInfo.population)}${missTxt}
    </div>
  `;
}



   

// ----- Charger le fichier communes_min.json une seule fois -----
let COMMUNES_MIN = null;
async function ensureCommunesMin() {
  if (!COMMUNES_MIN) {
    COMMUNES_MIN = await loadJSON('communes_min.json');
  }
}

// Distance Haversine (km)
function distKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// Retourne {5: pop, 10: pop, 15: pop, 20: pop} pour la commune choisie
function basinPopulations(codeInsee) {
  if (!COMMUNES_MIN) return null;
  const me = COMMUNES_MIN.find(c => c.code === codeInsee);
  if (!me || me.lat == null || me.lon == null) return null;

  const rays = [5,10,15,20];
  const res = {5:0, 10:0, 15:0, 20:0};

  for (const c of COMMUNES_MIN) {
    if (!Number.isFinite(c.population)) continue;
    const d = distKm(me.lat, me.lon, c.lat, c.lon);
    for (const r of rays) {
      if (d <= r) res[r] += c.population;
    }
  }
  return res;
}

// Rendu simple (commune + 4 lignes)
function renderBasinBlock(codeInsee) {
  if (!COMMUNES_MIN) return `<div class="error">Bassin indisponible.</div>`;
  const me = COMMUNES_MIN.find(c => c.code === codeInsee);
  if (!me) return `<div class="error">Commune inconnue.</div>`;

  const communePop = Number.isFinite(me.population) ? me.population : null;
  const res = basinPopulations(codeInsee);
  if (!res) return `<div class="error">Impossible de calculer le bassin.</div>`;

  return `
    <div class="muted" style="margin:6px 0">Population de la commune : <b>${communePop==null?'N/A':number(communePop)}</b> habitants</div>
    <div class="muted" style="margin:6px 0">Bassin de vie à 5 km : <b>${number(res[5])}</b> habitants</div>
    <div class="muted" style="margin:6px 0">Bassin de vie à 10 km : <b>${number(res[10])}</b> habitants</div>
    <div class="muted" style="margin:6px 0">Bassin de vie à 15 km : <b>${number(res[15])}</b> habitants</div>
    <div class="muted" style="margin:6px 0">Bassin de vie à 20 km : <b>${number(res[20])}</b> habitants</div>
  `;
}

   
  // ---------- DOM ----------
  const $ = (s) => document.querySelector(s);
  const villeInput = $('#ville');
  const btn = $('#btn');
  const suggestions = $('#suggestions');
  const msg = $('#msg');
  const out = $('#out');
  const btnSe = $('#btn-seloger');
  const seOut = $('#seloger-out');

  // ---------- Autocomplétion ----------
  async function searchAdresse(q){
    if(!q || q.length < 2) { suggestions.innerHTML = ''; btn.disabled = true; return; }
    suggestions.innerHTML = 'Recherche… <span class="loader"></span>';
    try{
      const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&type=municipality&autocomplete=1&limit=5`;
      const res = await fetch(url);
      const data = await res.json();
      if(!data.features.length){ suggestions.innerHTML = '<span class="muted">Aucune commune trouvée.</span>'; btn.disabled = true; return; }
      suggestions.innerHTML = data.features.map((f) => {
        const name = f.properties.label;
        const code = f.properties.citycode;
        return `<div class="sug" data-code="${code}" data-name="${name}" style="padding:6px 8px; border:1px solid #283060; background:#0b1128; border-radius:10px; margin-top:6px; cursor:pointer">${name} <span class="muted">(${code})</span></div>`;
      }).join('');
      suggestions.querySelectorAll('.sug').forEach(div => {
        div.addEventListener('click', () => {
          window.chosen = { name: div.dataset.name, code_insee: div.dataset.code };
          villeInput.value = div.dataset.name;
          suggestions.innerHTML = `<span class="muted">Commune sélectionnée : ${window.chosen.name} (${window.chosen.code_insee})</span>`;
          btn.disabled = false;
          villeInput.blur();
        });
      });
    } catch(e){
      suggestions.innerHTML = '<div class="error">Erreur de l’API Adresse.</div>';
      btn.disabled = true;
    }
  }
  villeInput.addEventListener('input', (e) => {
    window.chosen = null;
    out.classList.remove('show'); out.innerHTML = '';
    seOut.classList.remove('show'); seOut.innerHTML = '';
    searchAdresse(e.target.value);
  });


   
  // ---------- Bouton principal (12/24 mois) ----------
  btn.addEventListener('click', async () => {
    msg.innerHTML = '';
    out.classList.remove('show'); out.innerHTML = '';
    seOut.classList.remove('show'); seOut.innerHTML = '';

    if(!window.chosen){ msg.innerHTML = '<div class="error">Choisissez d’abord une commune.</div>'; return; }
    btn.disabled = true; btn.textContent = 'Chargement…';
    try {
      const [p12, p24] = await Promise.all([ loadJSON('prices_12.json'), loadJSON('prices_24.json') ]);
      const r12 = p12.data[window.chosen.code_insee];
      const r24 = p24.data[window.chosen.code_insee];

      function card(title, row, periode, devise){
        if(!row) return `<div class="error">Pas de données pour ${title.toLowerCase()}.</div>`;
        return `
          <div class="muted" style="margin:10px 0 4px">${title} — Période : ${periode} • Unité : ${devise}</div>
          <div class="stats">
            <div class="stat"><h3>Appartements</h3><div class="val">${euro(row.appart)}</div><div class="muted">médiane — n=${number(row.n_ventes.appart)}</div></div>
            <div class="stat"><h3>Maisons</h3><div class="val">${euro(row.maison)}</div><div class="muted">médiane — n=${number(row.n_ventes.maison)}</div></div>
          </div>
        `;
      }

      out.innerHTML = `
        ${card('12 derniers mois glissants', r12, p12.periode, p12.devise)}
        <hr style="border:0;border-top:1px solid #283060;margin:14px 0">
        ${card('24 derniers mois glissants', r24, p24.periode, p24.devise)}
        <div class="muted" style="margin-top:8px">
          Commune : <b>${(r12||r24)?.ville ?? window.chosen.name}</b> (${window.chosen.code_insee})
        </div>
      `;
      out.classList.add('show');

      // Population (commune sélectionnée)
      const pop = await fetchPopulationOne(window.chosen.code_insee);
      if (pop != null) {
        const popDiv = document.createElement('div');
        popDiv.className = 'muted';
        popDiv.style.marginTop = '8px';
        popDiv.textContent = `Population municipale (dernier recensement INSEE) : ${number(pop)} habitants`;
        out.appendChild(popDiv);
      }
    } catch (err) {
      out.innerHTML = `<div class="error">Impossible de charger les données.</div>`;
      out.classList.add('show');
    } finally {
      btn.disabled = false; btn.textContent = 'Rechercher';
    }

// --- Bassin de vie (4 rayons) ---
const basinMsg = document.getElementById('basin-msg');
const basinOut = document.getElementById('basin-out');
basinMsg.textContent = 'Calcul du bassin en cours…';
basinOut.innerHTML = '';
try {
  await ensureCommunesMin();                            // charge communes_min.json
  basinOut.innerHTML = renderBasinBlock(window.chosen.code_insee);
  basinMsg.textContent = '';
} catch (e) {
  basinMsg.textContent = '';
  basinOut.innerHTML = `<div class="error">Impossible de calculer le bassin.</div>`;
}


// … après avoir rendu les blocs 12/24 mois …
out.classList.add('show');

// (tu appelles déjà ensureAllLoaded/ensureCommunesMin selon tes besoins ailleurs)

const epciOut = document.getElementById('epci-out');
if (epciOut) {
  epciOut.classList.remove('show');
  epciOut.innerHTML = '';
  try {
    const info = await computeEPCIInfo(window.chosen.code_insee);
    epciOut.innerHTML = renderEPCI(info);
    epciOut.classList.add('show');
  } catch (e) {
    epciOut.innerHTML = `<div class="error">Impossible de récupérer l'EPCI.</div>`;
    epciOut.classList.add('show');
  }
}




    
  });

  // ---------- Bouton SeLoger ----------
  btnSe.addEventListener('click', async () => {
    if (!window.chosen) { msg.innerHTML = '<div class="error">Choisissez d’abord une commune.</div>'; return; }
    btnSe.disabled = true; btnSe.textContent = 'Recherche SeLoger…';
    try {
      const url = `/api/seloger?name=${encodeURIComponent(window.chosen.name)}&insee=${encodeURIComponent(window.chosen.code_insee)}&dept=${encodeURIComponent(window.chosen.code_insee.slice(0,2))}`;
      const r = await fetch(url);
      const s = await r.json();

      seOut.classList.add('show');
      seOut.innerHTML = `
        <div class="muted" style="margin:10px 0 4px">Prix constatés (SeLoger)</div>
        <div class="stats">
          <div class="stat"><h3>Appartements</h3><div class="val">${euro(s.appart)}</div></div>
          <div class="stat"><h3>Maisons</h3><div class="val">${euro(s.maison)}</div></div>
        </div>
        <div class="muted" style="margin-top:6px">
          ${s.source_url ? `Source : <a href="${s.source_url}" target="_blank" rel="noreferrer">SeLoger</a>` : `Non disponible pour cette commune`}
        </div>
      `;
    } catch (e) {
      seOut.classList.add('show');
      seOut.innerHTML = `<div class="error">Erreur SeLoger.</div>`;
    } finally {
      btnSe.disabled = false; btnSe.textContent = 'Chercher les prix constatés (SeLoger)';
    }
  });

  // ---------- Classement par département (avec population) ----------
  let PRICES12 = null, PRICES24 = null, POP_DATA = null;

  async function ensureAllLoaded() {
    if (!PRICES12 || !PRICES24) {
      [PRICES12, PRICES24] = await Promise.all([ loadJSON('prices_12.json'), loadJSON('prices_24.json') ]);
    }
    if (!POP_DATA) {
      POP_DATA = await loadJSON('population.json'); // généré par le workflow
    }
  }

 function makeRanking(dataObj, deptCode, kind, order, popMin, popMax) {
  const rows = [];
  for (const [insee, row] of Object.entries(dataObj.data)) {
    if (!row || row.dept !== deptCode) continue;

    const val = row[kind];
    if (val == null) continue;

   
const pop = (POP_DATA && POP_DATA[insee]) ?? null;

    if (pop == null) continue;
    if (pop < popMin || pop > popMax) continue;

    const n = row.n_ventes?.[kind] ?? null;
    rows.push({ insee, ville: row.ville, value: val, n, pop });
  }

  rows.sort((a,b) => (order === 'asc' ? a.value - b.value : b.value - a.value));
  return rows;
}

function renderRankingTable(rows, title) {
  const nb = rows.length;                // <— nombre de lignes après filtre
  if (!nb) return `<div class="error">Aucune donnée pour ces critères.</div>`;

  const head = `
    <div class="muted" style="margin-bottom:6px">
      ${title} — <b>${number(nb)}</b> villes concernées par ce filtre
    </div>
    <table style="width:100%; border-collapse:collapse">
      <thead>
        <tr>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #283060">
            Ville <span class="muted" style="font-weight:400">(${number(nb)})</span>
          </th>
          <th style="text-align:right; padding:8px; border-bottom:1px solid #283060">Population</th>
          <th style="text-align:right; padding:8px; border-bottom:1px solid #283060">Prix €/m²</th>
          <th style="text-align:right; padding:8px; border-bottom:1px solid #283060">n ventes</th>
        </tr>
      </thead>
      <tbody>
  `;

  const body = rows.map(r => `
    <tr>
      <td style="padding:8px; border-bottom:1px solid #1b2250">${r.ville} (${r.insee})</td>
      <td style="padding:8px; text-align:right; border-bottom:1px solid #1b2250">${number(r.pop)}</td>
      <td style="padding:8px; text-align:right; border-bottom:1px solid #1b2250">${euro(r.value)}</td>
      <td style="padding:8px; text-align:right; border-bottom:1px solid #1b2250">${number(r.n ?? 0)}</td>
    </tr>
  `).join('');

  const foot = `</tbody></table>`;
  return head + body + foot;
}


  const btnRanking = document.getElementById('btn-ranking');
  const rankingOut = document.getElementById('ranking-out');
  const rankingMsg = document.getElementById('ranking-msg');

 btnRanking.addEventListener('click', async () => {
  const dept  = document.getElementById('dept-code').value.trim().toUpperCase();
  const period = document.getElementById('period').value;
  const kind   = document.getElementById('kind').value;
  const order  = document.getElementById('order').value;

  const rawMin = parseInt(document.getElementById('pop-min').value, 10);
  const rawMax = parseInt(document.getElementById('pop-max').value, 10);
  let popMin = Number.isFinite(rawMin) ? rawMin : 1500;
  let popMax = Number.isFinite(rawMax) ? rawMax : 3500;

  rankingMsg.textContent = '';
  rankingOut.innerHTML = '';

  if (!dept) {
    rankingMsg.textContent = 'Saisissez un code département (ex : 74, 13, 2A, 2B).';
    return;
  }

  if (popMax < popMin) {
    [popMin, popMax] = [popMax, popMin];
  }

  try {
    await ensureAllLoaded(); // Charge PRICES12, PRICES24, et POP_DATA
    const dataObj = (period === '12') ? PRICES12 : PRICES24;
    const rows = makeRanking(dataObj, dept, kind, order, popMin, popMax);

    const title = `Département ${dept} • ${period} mois • ${kind === 'appart' ? 'Appartements' : 'Maisons'} • Population ${number(popMin)}–${number(popMax)} • Ordre ${order === 'asc' ? 'croissant' : 'décroissant'}`;
    rankingOut.innerHTML = renderRankingTable(rows, title);
  } catch (e) {
    rankingOut.innerHTML = `<div class="error">Erreur lors du chargement des données.</div>`;
  }
});

</script>

</body>
</html>
